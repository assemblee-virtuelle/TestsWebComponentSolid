<template id="edit-card">
    <style>
        #resourceInfo {
            width: 100%;
            margin:0 auto;
            background-color:rgba(90, 90, 90, 0.308);
        }
        #resourceInput {
            margin:0 auto;
            width:80%;
            margin-top:0;
            background-color: #695abb;
            text-align:center;
        }
        #title {
            width:100%;
            text-align:center;
        }
        #content {
            width:50%;
            margin: 0 auto;
        }
        #output {
            text-align:center;
            margin:10px;
            margin-top:20px;
            border:2px solid black;
        }
        #mainBlock {
            border:2px dashed lightgrey;
        }
        #mainTitle{
            padding: 5px;
            margin-left: 10%;
            border-radius: 5px 5px 0px 0px;
            width: fit-content;
            background-color: #6859bb;
            font-size: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .title{
            margin-top:3px;
            border-bottom:1px dashed black;
        }
        #submit{
            margin-bottom:10px;
        }
    </style>
    <div id="mainBlock">
        <div id="maintitle">Edit a card</div>
        <div id="resourceInput">
            <card-person></card-person>
            <p>Add rights to :</p>
            <acl-editor></acl-editor>
            <button id="submit">Envoi</button>
        </div>
        <div id="output">
            <p class="title">Preview card : </p>
            <resource-reader></resource-reader>
        </div>
    </div>
</template>
<script>
    class EditCard extends HTMLElement{
        constructor(){
            super();
            const shadowRoot = this.attachShadow({
                mode: 'open'
            });
            const templateCandidates = document.querySelectorAll('link[rel=import]');
            let template = null;
            for (let templateCandidate of templateCandidates) {
                template = templateCandidate.import.querySelector('#edit-card');
                if (template != null) {
                    break;
                }
            }
            const instance = template.content.cloneNode(true);
            this.shadowRoot.appendChild(instance);
            this.reader = this.shadowRoot.querySelector('resource-reader');
            this.aclEditor = this.shadowRoot.querySelector('acl-editor');
        }

        connectedCallback(){
            this.shadowRoot.getElementById("submit").addEventListener('click', this.editCard.bind(this));
        }

        editCard(){
            let innercard = this.shadowRoot.querySelector('card-person');
            let inputlist = innercard.shadowRoot.querySelectorAll('input');
            let data = [];
            for (let i = 0; i < inputlist.length; i++){
                if (inputlist[i].value != "")
                    data[inputlist[i].name] = inputlist[i].value;
            }
            
            this.postal.publish({
                channel:'solid',
                topic:'edit-card',
                data: {
                    request : data,
                    name:'card.ttl',
                    permissions: this.aclEditor.getPermissionData()
                }
            });
            this.setResponseChannels();
        }

        setPostal(postal){
            this.postal = postal;
            
        }

        setResponseChannels(){
            let done = this.postal.subscribe({
                channel:'solid',
                topic:'done-edit',
                callback:(data, enveloppe) => {
                    this.reader.display(data);
                }
            });

            let err = this.postal.subscribe({
                channel:'solid',
                topic:'err-edit',
                callback:(data, enveloppe) => {
                    this.reader.display(data);
                }
            });
        }
    }

window.customElements.define('edit-card', EditCard);
</script>