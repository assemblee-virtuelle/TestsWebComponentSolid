<template id="planet-permissions">
    <style>
        #list{
            display:flex;
            max-height:140px;
            flex-direction:column;
        }

        .mainDiv{
            background-color:rgb(102, 184, 231);
            display:flex;
            min-height: 20px;
            flex-direction:row;
            padding:5px;
        }

        .webidDiv{
            width:66%;
        }
        .permDiv{
            border-left:2px solid black;
            width:33%;
            display:flex;
            justify-content:space-between;
        }
        .control{
            padding: 0px 5px 0px 5px;
            background-color:aquamarine;
        }
        .delete{
            cursor: pointer;
        }

        
    </style>
    <div id="list">
    </div>
</template>
<script>
    let planet_permissions_template = document.currentScript.ownerDocument.getElementById('planet-permissions');

    class PlanetPermissions extends HTMLElement {
        constructor(){
            super();
            const shadowRoot = this.attachShadow({
                mode: 'open'
            });
            const instance = planet_permissions_template.content.cloneNode(true);
            this.shadowRoot.appendChild(instance);
            this.permBlockList = this.shadowRoot.getElementById("list");
            this.permList = {};
        }

        connectedCallback(){
            
        }

        static get observedAttributes(){
            return ['data-acl', 'data-uri'];
        }

        get uri(){
            return this.getAttribute('data-uri');
        }

        set uri(_uri){
            if (_uri){
                this.setAttribute('data-uri', _uri);
            }
        }

        get acl(){
            return this.getAttribute('data-acl');
        }

        set acl(_acl){
            if (_acl){
                this.setAttribute('data-acl', _acl);
            }
        }

        setPostal(postal){
            if (postal){
                this.postal = postal;
            }
            this.setPostalChannels();
        }

        setPostalChannels(){
            postal.subscribe({
                channel:'permissions',
                topic:'sendPermissionList',
                callback:this.populatePermList.bind(this)
            })
        }

        populatePermList(data){
            this.permBlockList.innerHTML = "";
            for(const group in data){
                if (data.hasOwnProperty(group)){
                    const element = data[group];
                    let perm = [];
                    for(let j = 0; j < element['permissions'].length; j++){
                        perm.push(this.permissionFromUri(element['permissions'][j]));
                    }
                    
                    this.permList[element['webid']] = perm;
                    this.newLine(element['webid'], perm);
                }
            }
        }

        newLine(webid, perm){
            let mainDiv = document.createElement('div');
            let webidDiv = document.createElement('div');
            let permDiv = document.createElement('div');
            
            let readDiv = document.createElement('div');
            readDiv.className = "perm read";
            let checkBoxRead = document.createElement('input');
            checkBoxRead.setAttribute('type', 'checkbox');
            checkBoxRead.setAttribute('disabled', true);
            let permTextRead = document.createElement('span');
            readDiv.appendChild(checkBoxRead);
            readDiv.appendChild(permTextRead);

            let writeDiv = document.createElement('div');
            writeDiv.className = "perm write";
            let checkBoxWrite = document.createElement('input');
            checkBoxWrite.setAttribute('type', 'checkbox');
            checkBoxWrite.setAttribute('disabled', true);
            let permTextWrite = document.createElement('span');
            writeDiv.appendChild(checkBoxWrite);
            writeDiv.appendChild(permTextWrite);

            let controlDiv = document.createElement('div');
            controlDiv.className = "perm control";
            let checkBoxControl = document.createElement('input');
            checkBoxControl.setAttribute('type', 'checkbox');
            checkBoxControl.setAttribute('disabled', true);
            let permTextControl = document.createElement('span');
            controlDiv.appendChild(checkBoxControl);
            controlDiv.appendChild(permTextControl);

            let deleteDiv = document.createElement('div');
            deleteDiv.className = "delete";
            let deleteImg = document.createElement('img');
            deleteImg.setAttribute('src', '/images/cancel.png');
            deleteImg.style.width = '20px';
            deleteDiv.appendChild(deleteImg);

            deleteDiv.addEventListener('click', ev => {
                this.deletePerm(ev);
            });

            mainDiv.className = 'mainDiv';
            webidDiv.className = 'webidDiv';
            permDiv.className = 'permDiv';

            permTextRead.innerText = 'Read';
            permTextWrite.innerText = 'Write';
            permTextControl.innerText = 'Control';

            permDiv.appendChild(readDiv);
            permDiv.appendChild(writeDiv);
            permDiv.appendChild(controlDiv);

            webidDiv.innerText = webid;

            for(let i = 0; i < perm.length; i++){
                switch (perm[i]) {
                    case 'Write':
                    checkBoxWrite.setAttribute('checked', true);
                        break;
                    case 'Read':
                    checkBoxRead.setAttribute('checked', true);
                        break;
                    case 'Control':
                    checkBoxControl.setAttribute('checked', true);
                        break;
                    default:
                        break; null;
                }
            }

            mainDiv.appendChild(deleteDiv);
            mainDiv.appendChild(webidDiv);
            mainDiv.appendChild(permDiv);

            this.permBlockList.appendChild(mainDiv);
        }

        permissionFromUri(perm){
            switch (perm) {
                case 'http://www.w3.org/ns/auth/acl#Write':
                    return 'Write';
                case 'http://www.w3.org/ns/auth/acl#Read':
                    return 'Read';
                case 'http://www.w3.org/ns/auth/acl#Control':
                    return 'Control';
                default:
                    return null;
            }
        }

        deletePerm(ev){
            let webid = ev.target.parentNode.parentNode.children[1].innerText;

            this.postal.publish({
                channel:'permissions',
                topic:'deletePerm',
                data:{webid:webid, acl:this.acl, uri:this.uri}
            })
        }

        attributeChangedCallback(name, oldValue, newValue) {
            if (newValue != null && name == 'data-acl'){

                this.permBlockList.innerHTML = "";
                this.postal.publish({
                    channel:'permissions',
                    topic:'urichange',
                    data: {acl:this.acl, uri:this.uri}
                })
            }
        }
    }
    window.customElements.define('planet-permissions', PlanetPermissions);
</script>